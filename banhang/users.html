<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Quản lý người dùng</title>

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">

    <style>
        body {
            background: #eef3fb;
        }
        .table th {
            background: #111;
            color: #fff;
        }
        .modal-title {
            font-weight: 700;
        }
    </style>
</head>
<body>

<div class="container mt-4">

    <!-- HEADER -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="fw-bold">
            <i class="fa fa-user"></i> Quản lý người dùng
        </h4>

        <div class="d-flex gap-2">
            <input type="text" id="txtSearch" class="form-control"
                   placeholder="Tìm username, họ tên, email...">
            <button class="btn btn-primary" id="btnAddUser">
                <i class="fa fa-plus"></i> Thêm user
            </button>
        </div>
    </div>

    <!-- TABLE -->
    <table class="table table-bordered table-hover align-middle">
        <thead>
            <tr>
                <th width="60">ID</th>
                <th>Username</th>
                <th>Họ tên</th>
                <th>Email</th>
                <th>Quyền</th>
                <th>Trạng thái</th>
                <th width="120">Hành động</th>
            </tr>
        </thead>
        <tbody id="userTable"></tbody>
    </table>
</div>

<!-- MODAL -->
<div class="modal fade" id="userModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <form class="modal-content" id="userForm" novalidate>
            <div class="modal-header">
                <h5 class="modal-title">Thông tin người dùng</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body row g-3">
                <input type="hidden" id="user_id">

                <div class="col-md-6">
                    <label class="form-label">Username</label>
                    <input type="text" id="username" class="form-control" required>
                </div>

                <div class="col-md-6">
                    <label class="form-label">Mật khẩu</label>
                    <input type="password" id="password" class="form-control"
                           placeholder="Để trống nếu không đổi">
                </div>

                <div class="col-md-6">
                    <label class="form-label">Họ tên</label>
                    <input type="text" id="full_name" class="form-control">
                </div>

                <div class="col-md-6">
                    <label class="form-label">Email</label>
                    <input type="email" id="email" class="form-control">
                </div>

                <div class="col-md-6">
                    <label class="form-label">Quyền</label>
                    <select id="role_id" class="form-select">
                        <option value="1">Admin</option>
                        <option value="2">Nhân viên bán hàng</option>
                        <option value="3">Quản lý</option>
                    </select>
                </div>

                <div class="col-md-6">
                    <label class="form-label">Trạng thái</label>
                    <select id="status" class="form-select">
                        <option value="1">Hoạt động</option>
                        <option value="0">Khoá</option>
                    </select>
                </div>
            </div>

            <div class="modal-footer">
                <button type="submit" class="btn btn-success">Lưu</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Huỷ</button>
            </div>
        </form>
    </div>
</div>

<!-- JS -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
$(function () {

    let users = [];
    let editMode = false;
    const modal = new bootstrap.Modal(document.getElementById("userModal"));

    // LOAD USERS
    function loadUsers() {
        $.getJSON("api/users_get.php", function (res) {
            users = res;
            renderTable(users);
        });
    }

    // RENDER TABLE
    function renderTable(data) {
        let html = "";
        data.forEach(u => {
            html += `
            <tr>
                <td>${u.user_id}</td>
                <td>${u.username}</td>
                <td>${u.full_name}</td>
                <td>${u.email}</td>
                <td>
                    <span class="badge ${u.role_id == 1 ? 'bg-primary' : 'bg-info'}">
                        ${u.role_name}
                    </span>
                </td>
                <td>
                    ${u.status == 1
                        ? '<span class="badge bg-success">Hoạt động</span>'
                        : '<span class="badge bg-danger">Khoá</span>'}
                </td>
                <td>
                    <button class="btn btn-warning btn-sm btn-edit" data-id="${u.user_id}">
                        <i class="fa fa-edit"></i>
                    </button>
                    <button class="btn btn-danger btn-sm btn-delete" data-id="${u.user_id}">
                        <i class="fa fa-trash"></i>
                    </button>
                </td>
            </tr>`;
        });
        $("#userTable").html(html);
    }

    // SEARCH
    $("#txtSearch").on("keyup", function () {
        let kw = $(this).val().toLowerCase();
        let filtered = users.filter(u =>
            u.username.toLowerCase().includes(kw) ||
            u.full_name.toLowerCase().includes(kw) ||
            u.email.toLowerCase().includes(kw)
        );
        renderTable(filtered);
    });

    // ADD USER
    $("#btnAddUser").click(function () {
        $("#userForm")[0].reset();
        $("#user_id").val("");
        editMode = false;
        modal.show();
    });

    // SUBMIT FORM
    $("#userForm").submit(function (e) {
        e.preventDefault();

        let url = editMode ? "api/users_update.php" : "api/users_add.php";

        $.ajax({
            url: url,
            type: "POST",
            dataType: "json",
            data: {
                user_id: $("#user_id").val(),
                username: $("#username").val(),
                password: $("#password").val(),
                full_name: $("#full_name").val(),
                email: $("#email").val(),
                role_id: $("#role_id").val(),
                status: $("#status").val()
            },
            success: function () {
                modal.hide();
                loadUsers();
            }
        });
    });

    // EDIT
    $(document).on("click", ".btn-edit", function () {
        let u = users.find(x => x.user_id == $(this).data("id"));
        $("#user_id").val(u.user_id);
        $("#username").val(u.username);
        $("#password").val("");
        $("#full_name").val(u.full_name);
        $("#email").val(u.email);
        $("#role_id").val(u.role_id);
        $("#status").val(u.status);
        editMode = true;
        modal.show();
    });

    // DELETE
    $(document).on("click", ".btn-delete", function () {
        if (!confirm("Xoá user này?")) return;
        $.post("api/users_delete.php",
            { user_id: $(this).data("id") },
            loadUsers
        );
    });

    loadUsers();
});
</script>

</body>
</html>
